# GitHub Actions workflow to checkout code and run Grype scan
name: Grype Security Scan

on:
  push:
    branches:
      - main
  schedule:
    # Run every Monday at 8:00 AM IST (2:30 AM UTC)
    - cron: '30 2 * * 1'

env:
  GRYPE_VERSION: "0.96.0" 

jobs:
  grype-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Bamboo-Plugin repository
        uses: actions/checkout@v4
        with:
          repository: checkmarx-ltd/Bamboo-Plugin
          path: Bamboo-Plugin
          ref: master

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Build with Maven
        run: |
          cd Bamboo-Plugin
          mvn clean install -DskipTests -B -q
        
      - name: Download and Install Grype
        run: |
          wget -q https://github.com/anchore/grype/releases/download/v${{ env.GRYPE_VERSION }}/grype_${{ env.GRYPE_VERSION }}_linux_amd64.tar.gz
          tar -xzf grype_${{ env.GRYPE_VERSION }}_linux_amd64.tar.gz
          sudo mv grype /usr/local/bin/
          grype version

      - name: Find JAR file
        id: find-jar
        run: |
          cd Bamboo-Plugin
          JAR_FILE=$(find . -name "checkmarx-bamboo-plugin-*.jar" -not -path "*/target/dependency/*" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)

          
          if [ -z "$JAR_FILE" ]; then
            echo "‚ùå JAR file not found!"
            exit 1
          fi
          
          echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "Found JAR file: $JAR_FILE"
          ls -la "$JAR_FILE"

      - name: Run Grype Security Scan
        id: grype-scan
        run: |
          cd Bamboo-Plugin
          echo "## üîç Grype Security Scan Results" > ../scan-results.md
          echo "**Repository:** checkmarx-ltd/Bamboo-Plugin" >> ../scan-results.md
          echo "**Scan Date:** $(date -u)" >> ../scan-results.md
          echo "**JAR File:** ${{ steps.find-jar.outputs.jar_file }}" >> ../scan-results.md
          echo "" >> ../scan-results.md
          
          # Run Grype scan and capture output
          grype ${{ steps.find-jar.outputs.jar_file }} -o table > ../grype-output.txt 2>&1
          GRYPE_EXIT_CODE=$?
          
          # Count vulnerabilities found
          VULN_COUNT=$(grep -c "^\|" ../grype-output.txt | awk '{print $1-1}' || echo "0")
          
          if [ "$GRYPE_EXIT_CODE" -eq 0 ] && [ "$VULN_COUNT" -le 1 ]; then
            echo "scan_status=success" >> $GITHUB_OUTPUT
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            echo "### ‚úÖ Scan completed successfully - No vulnerabilities found" >> ../scan-results.md
          else
            echo "scan_status=failed" >> $GITHUB_OUTPUT
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
            echo "### ‚ö†Ô∏è Vulnerabilities detected - $VULN_COUNT vulnerabilities found" >> ../scan-results.md
          fi
          
          echo "" >> ../scan-results.md
          echo "### Detailed Results:" >> ../scan-results.md
          echo '```' >> ../scan-results.md
          cat ../grype-output.txt >> ../scan-results.md
          echo '```' >> ../scan-results.md

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: grype-scan-results-${{ github.run_number }}
          path: |
            scan-results.md
            grype-output.txt
          retention-days: 30

      - name: Send Teams Notification (Only when vulnerabilities found)
        if: steps.grype-scan.outputs.vulnerabilities_found == 'true'
        uses: skitionek/notify-microsoft-teams@master
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          needs: ${{ toJson(needs) }}
          job: ${{ toJson(job) }}
          steps: ${{ toJson(steps) }}
          dry_run: false
          title: "üö® SECURITY ALERT: Vulnerabilities Found in Bamboo Plugin"
          summary: "Grype security scan detected vulnerabilities in checkmarx-ltd/Bamboo-Plugin"
          theme_color: "FF4444"
          sections: |
            [
              {
                "activityTitle": "üîç Grype Security Scan Results",
                "activitySubtitle": "Vulnerabilities detected - Immediate action required",
                "facts": [
                  {
                    "name": "Repository",
                    "value": "checkmarx-ltd/Bamboo-Plugin"
                  },
                  {
                    "name": "JAR File",
                    "value": "${{ steps.find-jar.outputs.jar_file }}"
                  },
                  {
                    "name": "Scan Date",
                    "value": "${{ github.event.head_commit.timestamp }}"
                  },
                  {
                    "name": "Status",
                    "value": "‚ö†Ô∏è Vulnerabilities Detected"
                  }
                ],
                "text": "**IMMEDIATE ACTION REQUIRED**\n\n1. Review detailed scan results in workflow artifacts\n2. Prioritize vulnerabilities by severity level\n3. Update affected dependencies\n4. Re-run scan to verify fixes\n\nPlease address these security issues promptly to maintain application security."
              }
            ]
          actions: |
            [
              {
                "@type": "OpenUri",
                "name": "View Workflow Run",
                "targets": [
                  {
                    "os": "default",
                    "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              },
              {
                "@type": "OpenUri", 
                "name": "Download Scan Results",
                "targets": [
                  {
                    "os": "default",
                    "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]

      - name: Log Scan Summary
        run: |
          echo "üîç Grype Security Scan Summary:"
          echo "- Scan Status: ${{ steps.grype-scan.outputs.scan_status }}"
          echo "- Vulnerabilities Found: ${{ steps.grype-scan.outputs.vulnerabilities_found }}"
          echo "- Email Notification: ${{ steps.grype-scan.outputs.vulnerabilities_found == 'true' && 'Sent' || 'Skipped (No vulnerabilities)' }}"

